<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dealer CRM v3.1</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="style.css">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.gif">
    <meta name="theme-color" content="#ffffff">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-building-fill-gear me-2"></i>Dealer CRM
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="/"><i class="bi bi-speedometer2"></i> Дашборд</a></li>
                    <li class="nav-item"><a class="nav-link" href="map.html"><i class="bi bi-map"></i> Карта</a></li>
                    <li class="nav-item"><a class="nav-link" href="sales.html"><i class="bi bi-graph-up"></i> Продажи</a></li>
                    <li class="nav-item"><a class="nav-link" href="report.html"><i class="bi bi-file-earmark-text"></i> Отчет</a></li>
                </ul>
                <div class="d-flex align-items-center gap-3 text-white">
                    <span class="badge bg-secondary" id="user-role-badge">Guest</span>
                    <button id="logout-btn" class="btn btn-outline-light btn-sm">Выйти</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3 main-container">
        
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h4 class="mb-0 fw-bold">Дилеры</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-light border btn-sm" id="btn-manage-statuses"><i class="bi bi-tags"></i> Статусы</button>
                <button class="btn btn-danger btn-sm text-white" id="open-add-modal-btn"><i class="bi bi-plus-lg"></i> Добавить</button>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-6 col-md-2"><select id="filter-city" class="form-select form-select-sm shadow-sm"><option value="">Город</option></select></div>
            <div class="col-6 col-md-2"><select id="filter-price-type" class="form-select form-select-sm shadow-sm"><option value="">Тип цен</option></select></div>
            <div class="col-6 col-md-2"><select id="filter-status" class="form-select form-select-sm shadow-sm"><option value="">Статус</option></select></div>
            <div class="col-6 col-md-2"><select id="filter-responsible" class="form-select form-select-sm shadow-sm"><option value="">Ответственный</option><option value="regional_astana">Региональный Астана</option><option value="regional_regions">Региональный Регионы</option><option value="office">Офис</option></select></div>
            <div class="col-12 col-md-4">
                <div class="input-group input-group-sm shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="search-bar" class="form-control border-start-0" placeholder="Поиск по названию или ID...">
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4" id="dashboard-stats">
            </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div id="dealer-grid" class="dealer-grid">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 small">Загрузка базы...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="add-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">Новый дилер</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="wizard-progress mb-4">
                        <div class="step-circle active" id="step-ind-1">1</div>
                        <div class="line"></div>
                        <div class="step-circle" id="step-ind-2">2</div>
                        <div class="line"></div>
                        <div class="step-circle" id="step-ind-3">3</div>
                        <div class="line"></div>
                        <div class="step-circle" id="step-ind-4">4</div>
                    </div>
                    
                    <form id="add-dealer-form">
                        <div class="wizard-step active" id="step-1">
                            <h6 class="mb-3">Основная информация</h6>
                            <div class="row g-3">
                                <div class="col-md-4"><input type="text" id="dealer_id" class="form-control" placeholder="ID (1C)" required></div>
                                <div class="col-md-8"><input type="text" id="name" class="form-control" placeholder="Название" required></div>
                                <div class="col-md-6"><input type="text" id="city" class="form-control" placeholder="Город"></div>
                                <div class="col-md-6"><input type="text" id="address" class="form-control" placeholder="Адрес"></div>
                                
                                <div class="col-md-6">
                                    <select id="status" class="form-select"></select>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2">
                                        <select id="responsible" class="form-select" onchange="toggleSectorSelect('add', this.value)">
                                            <option value="">Ответственный</option>
                                            <option value="regional_astana">Региональный Астана</option>
                                            <option value="regional_regions">Региональный Регионы</option>
                                            <option value="office">Офис</option>
                                        </select>
                                        <select id="add_region_sector" class="form-select" style="display:none; max-width: 130px;">
                                            <option value="">Сектор...</option>
                                            <option value="Север">Север</option>
                                            <option value="Юг">Юг</option>
                                            <option value="Запад">Запад</option>
                                            <option value="Восток">Восток</option>
                                            <option value="Центр">Центр</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6"><select id="price_type" class="form-select"><option value="">Тип цен</option></select></div>
                                
                                <div class="col-md-6">
                                    <label class="form-label small text-muted mb-1">Организации</label>
                                    <div id="add-org-list" class="d-flex flex-column gap-2 mb-2"></div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="btn-add-org-add">+ Организация</button>
                                </div>

                                <div class="col-md-12 bg-light p-2 rounded border">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="form-check form-switch ms-2">
                                            <input class="form-check-input" type="checkbox" id="add_contract_signed">
                                            <label class="form-check-label fw-bold" for="add_contract_signed">Договор подписан</label>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="small text-muted">Дата:</span>
                                            <input type="date" id="add_contract_date" class="form-control form-control-sm" style="width: auto;">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-12"><input type="text" id="delivery" class="form-control" placeholder="Условия доставки"></div>
                                <div class="col-md-4"><input type="text" id="website" class="form-control" placeholder="Сайт"></div>
                                <div class="col-md-4"><input type="text" id="instagram" class="form-control" placeholder="Instagram"></div>
                                <div class="col-md-4"><input type="text" id="bonuses" class="form-control" placeholder="Бонусы"></div>
                            </div>
                        </div>

                        <div class="wizard-step" id="step-2">
                            <h6 class="mb-3">Локация</h6>
                            <div class="input-group mb-2">
                                <input type="text" id="add-smart-search" class="form-control" placeholder="Поиск адреса...">
                                <button type="button" class="btn btn-outline-secondary" id="btn-search-add">Найти</button>
                                <button type="button" class="btn btn-outline-primary" id="btn-loc-add"><i class="bi bi-geo-alt"></i></button>
                            </div>
                            <div id="add-map" style="height: 300px; border-radius: 8px;" class="mb-2 bg-light border"></div>
                            <div class="row g-2">
                                <div class="col-6"><input type="text" id="add_latitude" class="form-control form-control-sm" readonly></div>
                                <div class="col-6"><input type="text" id="add_longitude" class="form-control form-control-sm" readonly></div>
                            </div>
                        </div>

                        <div class="wizard-step" id="step-3">
                            <h6 class="mb-3">Контакты</h6>
                            <div id="add-contact-list" class="mb-2"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mb-4" id="add-contact-btn-add-modal">+ Контакт</button>
                            
                            <h6 class="mb-3">POS Материалы</h6>
                            <div id="add-pos-list" class="mb-2"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mb-4" id="add-pos-btn-add-modal">+ Стенд</button>

                            <h6 class="mb-3">Конкуренты</h6>
                            <div id="add-competitor-list" class="mb-2"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-competitor-btn-add-modal">+ Конкурент</button>
                        </div>

                        <div class="wizard-step" id="step-4">
                            <h6 class="mb-3">Ассортимент</h6>
                            <div id="add-product-checklist" class="product-checklist-container"></div>
                            <div id="add-photo-preview-container" class="mt-3 d-flex gap-2 flex-wrap"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" id="btn-prev-step" style="display:none">Назад</button>
                    <button type="button" class="btn btn-primary" id="btn-next-step">Далее</button>
                    <button type="submit" form="add-dealer-form" class="btn btn-success" id="btn-finish-step" style="display:none">Завершить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="edit-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Редактирование</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <form id="edit-dealer-form">
                        <input type="hidden" id="edit_db_id">
                        
                        <ul class="nav nav-tabs nav-justified" role="tablist">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-info" type="button">Инфо</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-contacts" type="button">Детали</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-map" type="button">Карта</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-products" type="button">Товары</button></li>
                        </ul>

                        <div class="tab-content p-3">
                            <div class="tab-pane fade show active" id="tab-info">
                                <div class="row g-3">
                                    <div class="col-md-3"><label class="small text-muted">ID</label><input type="text" id="edit_dealer_id" class="form-control"></div>
                                    <div class="col-md-5"><label class="small text-muted">Название</label><input type="text" id="edit_name" class="form-control"></div>
                                    <div class="col-md-4"><label class="small text-muted">Статус</label><select id="edit_status" class="form-select"></select></div>
                                    
                                    <div class="col-md-4"><label class="small text-muted">Город</label><input type="text" id="edit_city" class="form-control"></div>
                                    <div class="col-md-8"><label class="small text-muted">Адрес</label><input type="text" id="edit_address" class="form-control"></div>
                                    
                                    <div class="col-md-4"><label class="small text-muted">Тип цен</label><select id="edit_price_type" class="form-select"></select></div>
                                    <div class="col-md-4">
                                        <label class="small text-muted">Ответственный</label>
                                        <div class="d-flex gap-2">
                                            <select id="edit_responsible" class="form-select" onchange="toggleSectorSelect('edit', this.value)"></select>
                                            <select id="edit_region_sector" class="form-select" style="display:none; max-width:130px">
                                                <option value="">Сектор...</option>
                                                <option value="Север">Север</option>
                                                <option value="Юг">Юг</option>
                                                <option value="Запад">Запад</option>
                                                <option value="Восток">Восток</option>
                                                <option value="Центр">Центр</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="small text-muted">Организации</label>
                                        <div id="edit-org-list" class="d-flex flex-column gap-2 mb-2"></div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="btn-edit-org-add">+ Организация</button>
                                    </div>

                                    <div class="col-md-12 bg-light p-2 rounded border">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="form-check form-switch ms-2">
                                                <input class="form-check-input" type="checkbox" id="edit_contract_signed">
                                                <label class="form-check-label fw-bold" for="edit_contract_signed">Договор подписан</label>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="small text-muted">Дата:</span>
                                                <input type="date" id="edit_contract_date" class="form-control form-control-sm" style="width: auto;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-12"><label class="small text-muted">Доставка</label><input type="text" id="edit_delivery" class="form-control"></div>
                                    <div class="col-md-4"><label class="small text-muted">Сайт</label><input type="text" id="edit_website" class="form-control"></div>
                                    <div class="col-md-4"><label class="small text-muted">Insta</label><input type="text" id="edit_instagram" class="form-control"></div>
                                    <div class="col-md-4"><label class="small text-muted">Бонусы</label><input type="text" id="edit_bonuses" class="form-control"></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-contacts">
                                <h6 class="text-primary mt-2">Контакты</h6>
                                <div id="edit-contact-list"></div>
                                <button type="button" class="btn btn-sm btn-light border w-100 mb-3" id="add-contact-btn-edit-modal">+ Добавить</button>

                                <h6 class="text-primary mt-2">POS Материалы</h6>
                                <div id="edit-pos-list"></div>
                                <button type="button" class="btn btn-sm btn-light border w-100 mb-3" id="add-pos-btn-edit-modal">+ Добавить</button>

                                <h6 class="text-primary mt-2">Конкуренты</h6>
                                <div id="edit-competitor-list"></div>
                                <button type="button" class="btn btn-sm btn-light border w-100 mb-3" id="add-competitor-btn-edit-modal">+ Добавить</button>
                                
                                <h6 class="text-primary mt-2">История визитов</h6>
                                <div id="edit-visits-list"></div>
                                <button type="button" class="btn btn-sm btn-light border w-100" id="add-visits-btn-edit-modal">+ Запись визита</button>
                            </div>

                            <div class="tab-pane fade" id="tab-map">
                                <div class="input-group mb-2">
                                    <input type="text" id="edit-smart-search" class="form-control" placeholder="Поиск...">
                                    <button type="button" class="btn btn-secondary" id="btn-search-edit">Найти</button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn-loc-edit">Я</button>
                                </div>
                                <div id="edit-map" style="height:400px; border-radius:8px;" class="bg-light border"></div>
                                <div class="row g-2 mt-2">
                                    <div class="col-6"><input type="text" id="edit_latitude" class="form-control form-control-sm" readonly></div>
                                    <div class="col-6"><input type="text" id="edit_longitude" class="form-control form-control-sm" readonly></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-products">
                                <div id="edit-product-checklist" class="product-checklist-container" style="max-height:400px;overflow-y:auto"></div>
                                <div id="edit-photo-preview-container" class="mt-3 d-flex gap-2 flex-wrap"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Закрыть</button>
                    <button type="submit" form="edit-dealer-form" class="btn btn-primary">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="status-manager-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Управление статусами</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 border-end">
                            <form id="status-form">
                                <input type="hidden" id="st_id">
                                <div class="mb-3">
                                    <label>Название</label>
                                    <input type="text" class="form-control" id="st_label" required>
                                </div>
                                <div class="mb-3">
                                    <label>ID (код)</label>
                                    <input type="text" class="form-control" id="st_value" placeholder="active, new...">
                                </div>
                                <div class="mb-3">
                                    <label>Цвет</label>
                                    <input type="color" class="form-control form-control-color w-100" id="st_color" value="#0d6efd">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="st_visible" checked>
                                    <label>Показывать</label>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary" id="btn-save-status">Добавить</button>
                                    <button type="button" class="btn btn-secondary" id="btn-cancel-edit-status" style="display:none">Отмена</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-8">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Цвет</th><th>Название</th><th>Код (ID)</th><th class="text-center">Глаз</th><th class="text-end">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="status-manager-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <datalist id="pos-materials-datalist"></datalist>
    <datalist id="brands-datalist"></datalist>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="script.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
    </script>
</body>
</html>
