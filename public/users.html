<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Сотрудники</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.gif" type="image/gif">

    <style>
        body { padding-bottom: 80px; background-color: #f8f9fa; }
        
        /* Карточка сотрудника (Mobile) */
        .user-card {
            background: white; border: none; border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            margin-bottom: 12px; transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .user-card:active { transform: scale(0.98); }
        .user-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        /* Аватар с инициалами */
        .avatar-circle {
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: white; font-size: 1.1rem;
            text-transform: uppercase; flex-shrink: 0;
        }

        /* Группы прав в модалке */
        .perm-group-header {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            font-weight: 700; color: #adb5bd; margin-bottom: 12px;
            border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;
        }
        
        /* Навигация (копия из index.html) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px); border-top: 1px solid #eee;
            z-index: 1050; padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .bottom-nav-item { text-align: center; color: #adb5bd; padding: 10px 0; text-decoration: none; flex: 1; transition: color 0.2s; }
        .bottom-nav-item.active { color: #B9040A; }
        .bottom-nav-item i { font-size: 1.4rem; display: block; margin-bottom: 2px; }
        .bottom-nav-item span { font-size: 0.65rem; font-weight: 600; }
        .desktop-nav { display: flex; }
        @media (max-width: 991px) { .desktop-nav { display: none !important; } }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4 desktop-nav">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><img src="logo.png" alt="CRM" height="30"></a>
            <div class="d-flex">
                <a href="/" class="btn btn-sm btn-light border"><i class="bi bi-arrow-left me-2"></i>На главную</a>
            </div>
        </div>
    </nav>

    <div class="container pt-3 pt-lg-0">
        <div class="row align-items-center mb-4 g-3">
            <div class="col-md-6">
                <h1 class="fw-bold fs-2 text-dark mb-0">Сотрудники</h1>
                <p class="text-muted small mb-0">Управление доступом и ролями</p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="openUserModal()">
                    <i class="bi bi-person-plus-fill me-2"></i>Добавить
                </button>
            </div>
        </div>

        <div class="bg-white p-2 rounded-4 shadow-sm mb-4 border border-light">
            <div class="input-group border-0">
                <span class="input-group-text bg-white border-0 ps-3 text-muted"><i class="bi bi-search"></i></span>
                <input type="text" id="user-search" class="form-control border-0 shadow-none" placeholder="Поиск по имени или логину...">
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden d-none d-md-block">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr class="text-muted small text-uppercase">
                            <th class="ps-4 py-3">Пользователь</th>
                            <th>Роль</th>
                            <th>Регион</th>
                            <th>Статус</th>
                            <th class="text-end pe-4">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="d-md-none" id="users-mobile-list">
            </div>
        
        <div id="no-users-msg" class="text-center text-muted mt-5" style="display:none">
            <i class="bi bi-person-x display-1 text-light"></i>
            <p class="mt-3">Сотрудники не найдены</p>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 rounded-4 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Настройка сотрудника</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="userForm">
                        <input type="hidden" id="u_id">
                        
                        <div class="card border-0 shadow-sm rounded-4 mb-3">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3 text-dark">Учетная запись</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">ФИО</label>
                                        <input type="text" id="u_fullName" class="form-control" required placeholder="Иван Иванов">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Логин (для входа)</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white text-muted border-end-0">@</span>
                                            <input type="text" id="u_username" class="form-control border-start-0 ps-0" required placeholder="ivan">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Пароль</label>
                                        <input type="text" id="u_password" class="form-control" placeholder="Оставьте пустым, если не меняете">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Регион (Scope)</label>
                                        <select id="u_scope" class="form-select">
                                            <option value="all">Вся компания (All)</option>
                                            <option value="astana">Только Астана</option>
                                            <option value="regions">Только Регионы</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-warning border-opacity-25 bg-warning-subtle rounded-4 mb-3">
                            <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-shield-lock-fill text-warning me-2"></i>Администратор</h6>
                                    <small class="text-dark opacity-75" style="font-size: 0.75rem">Полный доступ ко всем функциям без ограничений</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input perm-check" type="checkbox" id="p_is_admin" style="transform: scale(1.3);">
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm rounded-4">
                                    <div class="card-body">
                                        <div class="perm-group-header">Доступ к меню</div>
                                        
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_dealers"><label class="form-check-label" for="p_can_view_dealers">Список дилеров (Главная)</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_map"><label class="form-check-label" for="p_can_view_map">Карта дилеров</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_products"><label class="form-check-label" for="p_can_view_products">Каталог (Матрица)</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_report"><label class="form-check-label" for="p_can_view_report">Отчет (Выставленность)</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_sales"><label class="form-check-label" for="p_can_view_sales">Продажи (Таблица)</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_competitors"><label class="form-check-label" for="p_can_view_competitors">Конкуренты</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_knowledge"><label class="form-check-label" for="p_can_view_knowledge">База знаний</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_view_dashboard"><label class="form-check-label" for="p_can_view_dashboard">Дашборд (Статистика)</label></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm rounded-4">
                                    <div class="card-body">
                                        <div class="perm-group-header text-primary">Редактирование</div>
                                        
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_create_dealer"><label class="form-check-label" for="p_can_create_dealer">Создавать дилера</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_edit_dealer"><label class="form-check-label" for="p_can_edit_dealer">Редактировать дилера</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_manage_visits"><label class="form-check-label" for="p_can_manage_visits">Добавлять визиты</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_edit_sales_fact"><label class="form-check-label" for="p_can_edit_sales_fact">Вносить Факт продаж</label></div>
                                        
                                        <div class="perm-group-header text-success mt-3">Справочники</div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_manage_products"><label class="form-check-label" for="p_can_manage_products">Управлять товарами (SKU)</label></div>
                                        <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_manage_competitors"><label class="form-check-label" for="p_can_manage_competitors">Управлять брендами</label></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="card border-danger border-opacity-25 bg-white shadow-sm rounded-4">
                                    <div class="card-body">
                                        <div class="perm-group-header text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Зона риска</div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_delete_dealer"><label class="form-check-label text-danger fw-bold" for="p_can_delete_dealer">Удалять дилера</label></div>
                                                <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_manage_users"><label class="form-check-label text-danger fw-bold" for="p_can_manage_users">Управлять сотрудниками</label></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_export_base"><label class="form-check-label text-danger" for="p_can_export_base">Скачать Базу (Excel)</label></div>
                                                <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_export_prices"><label class="form-check-label text-danger" for="p_can_export_prices">Скачать Цены (Excel)</label></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check form-switch"><input class="form-check-input perm-check" type="checkbox" id="p_can_edit_sales_plan"><label class="form-check-label text-danger fw-bold" for="p_can_edit_sales_plan">Менять ПЛАН продаж</label></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 text-end">
                                <div class="d-inline-block bg-white border rounded-3 p-2 shadow-sm">
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="checkbox" id="u_isBlocked">
                                        <label class="form-check-label text-danger fw-bold" for="u_isBlocked">⛔ ЗАБЛОКИРОВАТЬ ДОСТУП</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary rounded-pill py-2 shadow fw-bold">Сохранить изменения</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav d-flex justify-content-around d-lg-none">
        <a href="/" class="bottom-nav-item">
            <i class="bi bi-shop"></i><span>Дилеры</span>
        </a>
        <a href="#" class="bottom-nav-item active">
            <i class="bi bi-shield-lock-fill"></i><span>Права</span>
        </a>
        <a href="/sales.html" class="bottom-nav-item">
            <i class="bi bi-graph-up-arrow"></i><span>Продажи</span>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- AUTH INTERCEPTOR ---
        const originalFetch = window.fetch;
        window.fetch = async function (url, options) {
            options = options || {}; options.headers = options.headers || {};
            const token = localStorage.getItem('crm_token');
            if (token) options.headers['Authorization'] = 'Bearer ' + token;
            const response = await originalFetch(url, options);
            if (response.status === 401) window.location.href = '/login.html';
            return response;
        };

        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        const tbody = document.getElementById('users-table-body');
        const mobileList = document.getElementById('users-mobile-list');
        const searchInput = document.getElementById('user-search');
        let allUsers = [];

        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                if (!res.ok) throw new Error('Ошибка доступа');
                allUsers = await res.json();
                render();
            } catch (e) {
                // Если ошибка - выкидываем на главную, т.к. сюда нельзя без прав
                window.location.href = '/'; 
            }
        }

        function getAvatarColor(name) {
            const colors = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        function getInitials(name) {
            const parts = name.trim().split(' ');
            if(parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
            if(parts.length === 1 && parts[0].length > 1) return parts[0].substring(0, 2).toUpperCase();
            return name.substring(0, 1).toUpperCase();
        }

        function render() {
            const term = searchInput.value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.fullName || '').toLowerCase().includes(term) || 
                u.username.toLowerCase().includes(term)
            );

            if(filtered.length === 0) {
                document.getElementById('no-users-msg').style.display = 'block';
                tbody.innerHTML = ''; mobileList.innerHTML = '';
                return;
            }
            document.getElementById('no-users-msg').style.display = 'none';

            // Desktop Render
            tbody.innerHTML = filtered.map(u => {
                const color = getAvatarColor(u.fullName || u.username);
                const initials = getInitials(u.fullName || u.username);
                
                const roleBadge = u.permissions.is_admin 
                    ? '<span class="badge bg-warning text-dark border border-warning"><i class="bi bi-star-fill me-1"></i>Админ</span>' 
                    : '<span class="badge bg-light text-secondary border">Менеджер</span>';
                
                const statusBadge = u.isBlocked 
                    ? '<span class="badge bg-danger-subtle text-danger"><i class="bi bi-lock-fill me-1"></i>Блок</span>' 
                    : '<span class="badge bg-success-subtle text-success"><i class="bi bi-check-circle-fill me-1"></i>Активен</span>';

                return `
                <tr class="${u.isBlocked ? 'opacity-50' : ''}">
                    <td class="ps-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle shadow-sm me-3" style="background:${color}">${initials}</div>
                            <div>
                                <div class="fw-bold text-dark">${u.fullName || 'Без имени'}</div>
                                <div class="small text-muted">@${u.username}</div>
                            </div>
                        </div>
                    </td>
                    <td>${roleBadge}</td>
                    <td><span class="badge bg-light text-dark border fw-normal text-uppercase">${u.scope}</span></td>
                    <td>${statusBadge}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-white border shadow-sm me-1" onclick="editUser('${u._id}')">
                            <i class="bi bi-gear-fill text-secondary"></i>
                        </button>
                        ${!u.permissions.is_admin ? `<button class="btn btn-sm btn-white border shadow-sm text-danger" onclick="deleteUser('${u._id}')"><i class="bi bi-trash"></i></button>` : ''}
                    </td>
                </tr>`;
            }).join('');

            // Mobile Render
            mobileList.innerHTML = filtered.map(u => {
                const color = getAvatarColor(u.fullName || u.username);
                const initials = getInitials(u.fullName || u.username);
                const roleText = u.permissions.is_admin ? 'Администратор' : 'Менеджер';
                const roleClass = u.permissions.is_admin ? 'text-warning' : 'text-muted';

                return `
                <div class="user-card p-3 d-flex align-items-center" onclick="editUser('${u._id}')">
                    <div class="avatar-circle shadow-sm me-3" style="background:${color}">${initials}</div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold mb-0 ${u.isBlocked ? 'text-decoration-line-through text-muted':''}">${u.fullName || '@'+u.username}</h6>
                            ${u.isBlocked ? '<span class="badge bg-danger-subtle text-danger small">Блок</span>' : ''}
                        </div>
                        <div class="small ${roleClass} fw-bold mt-1">${roleText} &bull; <span class="text-secondary fw-normal text-uppercase">${u.scope}</span></div>
                    </div>
                    <i class="bi bi-chevron-right text-muted opacity-25 ms-2"></i>
                </div>`;
            }).join('');
        }

        window.openUserModal = () => {
            document.getElementById('userForm').reset();
            document.getElementById('u_id').value = '';
            document.getElementById('modalTitle').innerText = 'Новый сотрудник';
            document.querySelectorAll('.perm-check').forEach(cb => cb.checked = false);
            
            // Базовые права по умолчанию
            ['p_can_view_map', 'p_can_view_dealers', 'p_can_view_sales', 'p_can_add_visit', 'p_can_view_dashboard'].forEach(id => {
                const el = document.getElementById(id); if(el) el.checked = true;
            });
            modal.show();
        }

        window.editUser = (id) => {
            const u = allUsers.find(x => x._id === id);
            if(!u) return;
            
            document.getElementById('u_id').value = u._id;
            document.getElementById('u_fullName').value = u.fullName || '';
            document.getElementById('u_username').value = u.username;
            document.getElementById('u_password').value = ''; 
            document.getElementById('u_scope').value = u.scope;
            document.getElementById('u_isBlocked').checked = u.isBlocked;

            // Сброс
            document.querySelectorAll('.perm-check').forEach(cb => cb.checked = false);

            // Заполнение
            if (u.permissions) {
                for (const [key, val] of Object.entries(u.permissions)) {
                    const el = document.getElementById(`p_${key}`);
                    if(el) el.checked = val;
                }
            }

            document.getElementById('modalTitle').innerText = 'Редактирование';
            modal.show();
        }

        window.deleteUser = async (id) => {
            if(!confirm('Удалить сотрудника безвозвратно?')) return;
            await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
            loadUsers();
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('u_id').value;
            
            const permissions = {};
            document.querySelectorAll('.perm-check').forEach(cb => {
                permissions[cb.id.replace('p_', '')] = cb.checked;
            });

            const data = {
                fullName: document.getElementById('u_fullName').value,
                username: document.getElementById('u_username').value,
                password: document.getElementById('u_password').value,
                scope: document.getElementById('u_scope').value,
                isBlocked: document.getElementById('u_isBlocked').checked,
                permissions
            };

            const url = id ? `/api/admin/users/${id}` : '/api/admin/users';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if(!res.ok) throw new Error('Ошибка сохранения');
                
                modal.hide();
                loadUsers();
            } catch (e) {
                alert(e.message);
            }
        });

        searchInput.addEventListener('input', render);
        loadUsers();
    </script>
</body>
</html>
